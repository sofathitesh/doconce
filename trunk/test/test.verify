#!/usr/bin/env python
import commands, os

# recommendation: remove installation and reinstall (to test setup.py)

# in addition to the tests below (testdoc, tutorial, manual) one
# should try the easyviz documentation as that docment has a lot
# of figures and cross references (is a nice example of doconce too)

thisdir = os.getcwd()
logfilename = os.path.join(thisdir, 'test.v')
log = open(logfilename, 'w')
log.close()  # just touch the file

def add(filename, logfile):
    print '...adding file', filename
    logfile.write("""
************** File: %s *****************
""" % filename)
    if not os.path.isfile(filename):
        logfile.write('NOT FOUND!')
    else:
        f = open(filename, 'r')
        fstr = f.read()
        f.close()
        logfile.write(fstr)

# test multiple authors
failure = os.system('./clean.sh')
if failure:
    raise OSError, 'Could not run clean.sh successfully'    
failure = os.system('./make.sh')
if failure:
    raise OSError, 'Could not run make.sh successfully'    

log = open(logfilename, 'a')
files = '.do.txt', '.html', '.p.tex', '.rst', '.sphinx.rst', '.gwiki', '.st', '.epytext', '.txt'
files = ['testdoc' + ext for ext in files]
for f in files:
    add(f, log)
add('make.sh', log)
log.close()

tutdir = os.path.join(os.pardir, 'docs', 'tutorial')
print 'cd', tutdir
os.chdir(tutdir)

print '...running ./make.sh in docs/tutorial'  # works only under Unix...
failure = os.system('./clean.sh')
if failure:
    raise OSError, 'Could not run clean.sh successfully'    
failure = os.system('./make.sh')
if failure:
    raise OSError, 'Could not run make.sh successfully'    

log = open(logfilename, 'a')
add('make.sh', log)
os.chdir('demo')
# concentrate on files generated by doconce (not rst2*.py):
files = '.do.txt', '.html', '.p.tex', '.rst', '.sphinx.rst', '.gwiki', '.st', '.epytext', '.txt'
files = ['tutorial' + ext for ext in files]
for f in files:
    add(f, log)

# test DocWriter:
os.chdir(thisdir)
failure, output = commands.getstatusoutput('python ../lib/doconce/DocWriter.py')
files = 'tmp_Doconce.do.txt', 'tmp_DocWriter.do.txt', 'tmp_DocWriter.html', \
        'tmp_HTML.html'
for f in files:
    add(f, log)

log.close()

# test manual:
mandir = os.path.join(os.pardir, 'docs', 'manual')
print 'cd', mandir
os.chdir(mandir)

print '...running ./make.sh in docs/manual'  # works only under Unix...
failure = os.system('./clean.sh')
if failure:
    raise OSError, 'Could not run clean.sh successfully'    
failure = os.system('./make.sh')
if failure:
    raise OSError, 'Could not run make.sh successfully'    

log = open(logfilename, 'a')
add('make.sh', log)
files = '.do.txt', '.html', '.p.tex', '.rst', '.sphinx.rst', '.gwiki', '.st', '.epytext', '.txt'
files = ['manual' + ext for ext in files]
for f in files:
    add(f, log)

log.close()
