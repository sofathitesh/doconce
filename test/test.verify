#!/usr/bin/env python
import commands, os, sys, commands

# recommendation: remove installation and reinstall (to test setup.py)

# in addition to the tests below (testdoc, tutorial, manual) one
# should try the easyviz documentation as that docment has a lot
# of figures and cross references (is a nice example of doconce too)

thisdir = os.getcwd()
logfilename = os.path.join(thisdir, 'test.v')
log = open(logfilename, 'w')
log.close()  # just touch the file
outputfilename = os.path.join(thisdir, 'test.output')
f = open(outputfilename, 'w')  # touch
f.close()

def add(filename, logfile):
    print '...adding file', filename
    logfile.write("""
************** File: %s *****************
""" % filename)
    if not os.path.isfile(filename):
        logfile.write('NOT FOUND!')
    else:
        f = open(filename, 'r')
        fstr = f.read()
        f.close()
        logfile.write(fstr)

def clean_and_make(append=True):
    failure = os.system('./clean.sh > /dev/null')
    if failure:
        raise OSError('Could not run clean.sh successfully')
    failure, output = commands.getstatusoutput('./make.sh')
    f = open(outputfilename, 'a');  f.write(output);  f.close()
    if failure:
        where = os.getcwd()
        raise OSError('Could not run %s/make.sh successfully!\nRerun manually (go to %s and run ./make.sh' % (where, where))

# test multiple authors, figure, movie, math, encodings, etc:
print '...running ./make.sh in test'  # works only under Unix...
clean_and_make(append=False)

log = open(logfilename, 'a')
files = '.do.txt', '.html', '.p.tex', '.rst', '.sphinx.rst', '.gwiki', '.st', '.epytext', '.txt'
files = ['testdoc' + ext for ext in files] + ['tmp_encoding.txt']
for f in files:
    add(f, log)
add('make.sh', log)
log.close()

tutdir = os.path.join(os.pardir, 'doc', 'tutorial')
print 'cd', tutdir
os.chdir(tutdir)

print '...running ./make.sh in doc/tutorial'  # works only under Unix...
clean_and_make()

log = open(logfilename, 'a')
add('make.sh', log)
os.chdir('demo')
# concentrate on files generated by doconce (not rst2*.py):
files = '.do.txt', '.html', '.p.tex', '.rst', '.sphinx.rst', '.gwiki', '.st', '.epytext', '.txt'
files = ['tutorial' + ext for ext in files]
for f in files:
    add(f, log)

# test DocWriter:
os.chdir(thisdir)
failure, output = commands.getstatusoutput('python ../lib/doconce/DocWriter.py')
files = 'tmp_Doconce.do.txt', 'tmp_DocWriter.do.txt', 'tmp_DocWriter.html', \
        'tmp_HTML.html'
for f in files:
    add(f, log)

log.close()

# test manual:
mandir = os.path.join(os.pardir, 'doc', 'manual')
print 'cd', mandir
os.chdir(mandir)

print '...running ./make.sh in doc/manual'  # works only under Unix...
clean_and_make()

log = open(logfilename, 'a')
add('make.sh', log)
files = '.do.txt', '.html', '.p.tex', '.rst', '.sphinx.rst', '.gwiki', '.st', '.epytext', '.txt'
files = ['manual' + ext for ext in files]
for f in files:
    add(f, log)

os.chdir(thisdir)
add(outputfilename, log)
log.close()

# test quickref:
mandir = os.path.join(os.pardir, 'doc', 'quickref')
print 'cd', mandir
os.chdir(mandir)

print '...running ./make.sh in doc/quickref'  # works only under Unix...
clean_and_make()

log = open(logfilename, 'a')
add('make.sh', log)
files = '.do.txt', '.html', '.p.tex', '.rst', '.sphinx.rst', '.gwiki', '.st', '.epytext', '.txt',
files = ['quickref' + ext for ext in files]
for f in files:
    add(f, log)

os.chdir(thisdir)
add(outputfilename, log)
log.close()
